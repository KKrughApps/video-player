<!DOCTYPE html>
<html>
<head>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
        .vjs-language-menu, .vjs-playlist-nav { display: inline-block; }
        .video-js { max-width: 100%; }
        .vjs-playlist-nav button { font-size: 18px; padding: 5px 10px; cursor: pointer; }
        video { pointer-events: none; } /* Disable right-click */
    </style>
</head>
<body>
    <div class="vjs-video-container">
        <video id="videoPlayer" class="video-js vjs-default-skin" controls width="600" height="340"></video>
    </div>

    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <script>
        const player = videojs('videoPlayer', {
            fluid: true,
            controlBar: {
                children: ['playToggle', 'volumePanel', 'progressControl', 'captionsButton', 'fullscreenToggle']
            }
        });

        let audioElement = new Audio();
        let currentVideoIndex = 0;
        let currentLang = 'en'; // Default language
        let videos = [];
        let baseDuration = 140;

        player.on('play', () => audioElement.play());
        player.on('pause', () => audioElement.pause());
        player.on('seeking', () => audioElement.currentTime = player.currentTime() - 3); // 3s offset

        // Language Menu (Video.js 8.x compatible)
        class LanguageMenu extends videojs.getComponent('MenuButton') {
            constructor(player, options) {
                super(player, options);
                this.addClass('vjs-language-menu');
            }

            createEl() {
                return super.createEl('button', {
                    className: 'vjs-language-menu vjs-control vjs-button'
                });
            }

            createMenu() {
                const menu = new videojs.getComponent('Menu')(this.player_, { menuButton: this });
                videos[currentVideoIndex].languages.forEach((lang, index) => {
                    const item = new videojs.getComponent('MenuItem')(this.player_, {
                        label: lang.label,
                        selectable: true,
                        selected: lang.code === currentLang
                    });
                    item.on('click', () => {
                        currentLang = lang.code;
                        audioElement.src = lang.audio;
                        audioElement.load();
                        if (!this.player_.paused()) audioElement.play();
                        this.player_.playbackRate(baseDuration / lang.duration);
                        this.player_.currentTime(3); // Start at 0:03
                    });
                    menu.addItem(item);
                });
                return menu;
            }
        }

        videojs.registerComponent('LanguageMenu', LanguageMenu);

        // Fetch videos and initialize
        console.log("Fetching API...");
        fetch('https://video-api.keith-9d4.workers.dev')
            .then(res => res.json())
            .then(data => {
                console.log("API response:", data);
                videos = data.videos;
                player.src(videos[0].video);
                audioElement.src = videos[0].languages[0].audio;
                baseDuration = videos[0].baseDuration;
                player.playbackRate(baseDuration / videos[0].languages[0].duration);
                player.currentTime(3);
                player.controlBar.addChild('LanguageMenu', {});
            })
            .catch(error => {
                console.error("Fetch error:", error);
            });

        // Disable right-click on video
        document.getElementById('videoPlayer').addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });
    </script>
</body>
</html>
