<!DOCTYPE html>
<html>
<head>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
        .vjs-language-menu, .vjs-playlist-nav { display: inline-block; }
        .video-js { max-width: 100%; width: 800px; height: 450px; margin: 0 auto; }
        .vjs-playlist-nav button { font-size: 18px; padding: 5px 10px; cursor: pointer; }
        video { pointer-events: none; } /* Disable right-click */
        .vjs-language-menu { display: inline-block !important; }
        .vjs-language-menu .vjs-button { cursor: pointer; display: inline-block; }
        .vjs-menu { display: none; position: absolute; bottom: 3em; background-color: #2B333F; border: 1px solid #121415; z-index: 1000; }
        .vjs-menu.visible { display: block; }
        .vjs-menu-content { list-style: none; margin: 0; padding: 0; }
        .vjs-menu-item { color: white; padding: 5px 10px; cursor: pointer; }
        .vjs-menu-item:hover { background-color: #4e5d6c; }
        .vjs-selected { background-color: #4e5d6c; }
    </style>
</head>
<body>
    <div class="vjs-video-container">
        <video id="videoPlayer" class="video-js vjs-default-skin" controls></video>
    </div>

    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <script>
        const player = videojs('videoPlayer', {
            fluid: false,
            width: 800,
            height: 450,
            controlBar: {
                children: [
                    'playToggle',
                    'volumePanel',
                    'currentTimeDisplay',
                    'timeDivider',
                    'durationDisplay',
                    'progressControl',
                    'captionsButton',
                    'fullscreenToggle'
                ]
            }
        });

        let audioElement = new Audio();
        let currentVideoIndex = 0;
        let currentLang = 'en'; // Default language
        let videos = [];
        let baseDuration = 140;

        player.on('play', () => audioElement.play());
        player.on('pause', () => audioElement.pause());
        player.on('seeking', () => audioElement.currentTime = player.currentTime() - 3); // 3s offset

        // Language Menu (Video.js 8.x compatible)
        class LanguageMenu extends videojs.getComponent('MenuButton') {
            constructor(player, options) {
                super(player, options);
                this.addClass('vjs-language-menu');
                console.log("LanguageMenu instantiated");
            }

            createEl() {
                const el = videojs.dom.createEl('button', {
                    className: 'vjs-language-menu vjs-control vjs-button',
                    innerHTML: 'Language'
                });
                console.log("LanguageMenu button created:", el);
                return el;
            }

            handleClick() {
                console.log("LanguageMenu clicked");
                if (!videos[currentVideoIndex] || !videos[currentVideoIndex].languages) {
                    console.log("No languages available");
                    return;
                }
                const menu = this.createMenu();
                if (this.menu) {
                    this.removeChild(this.menu);
                }
                this.menu = menu;
                this.addChild(menu);
                this.menu.el_.classList.toggle('visible');
                console.log("Menu toggled:", this.menu.el_.classList.contains('visible'));
            }

            createMenu() {
                console.log("Creating LanguageMenu");
                const menuEl = videojs.dom.createEl('ul', { className: 'vjs-menu-content' });
                const menu = new videojs.getComponent('Component')(this.player_, {}, menuEl);
                videos[currentVideoIndex].languages.forEach((lang, index) => {
                    const itemEl = videojs.dom.createEl('li', {
                        className: 'vjs-menu-item',
                        innerHTML: lang.label
                    });
                    if (lang.code === currentLang) {
                        itemEl.classList.add('vjs-selected');
                    }
                    itemEl.addEventListener('click', () => {
                        console.log("Selected language:", lang.label);
                        currentLang = lang.code;
                        audioElement.src = lang.audio;
                        audioElement.load();
                        if (!this.player_.paused()) audioElement.play();
                        this.player_.playbackRate(baseDuration / lang.duration);
                        this.player_.duration(lang.duration);
                        this.player_.currentTime(3);
                        this.menu.el_.classList.remove('visible');
                        const items = this.menu.el_.querySelectorAll('.vjs-menu-item');
                        items.forEach(i => i.classList.remove('vjs-selected'));
                        itemEl.classList.add('vjs-selected');
                    });
                    menuEl.appendChild(itemEl);
                });
                return menu;
            }
        }

        videojs.registerComponent('LanguageMenu', LanguageMenu);

        // Fetch videos and initialize
        console.log("Fetching API...");
        fetch('https://video-api.keith-9d4.workers.dev')
            .then(res => res.json())
            .then(data => {
                console.log("API response:", data);
                videos = data.videos;
                player.src(videos[0].video);
                audioElement.src = videos[0].languages[0].audio;
                baseDuration = videos[0].baseDuration;
                player.playbackRate(baseDuration / videos[0].languages[0].duration);
                player.duration(videos[0].languages[0].duration);
                player.currentTime(3);
                console.log("Adding LanguageMenu...");
                player.controlBar.addChild('LanguageMenu', {});
            })
            .catch(error => {
                console.error("Fetch error:", error);
            });

        // Disable right-click on video
        document.getElementById('videoPlayer').addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });
    </script>
</body>
</html>
